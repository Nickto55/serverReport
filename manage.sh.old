#!/bin/bash

#############################################################################
# ServerReport - Management Script
# Easy server management and maintenance
#############################################################################

set +e  # Don't exit on errors

# Colors and styles
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
DOCKER_DIR="$SCRIPT_DIR/docker"
ENV_FILE="$SCRIPT_DIR/config/.env"

# ==================== HELPER FUNCTIONS ====================

print_header() {
    echo -e "\n${MAGENTA}${BOLD}════════════════════════════════════════════════════════${NC}"
    echo -e "${MAGENTA}${BOLD}$1${NC}"
    echo -e "${MAGENTA}${BOLD}════════════════════════════════════════════════════════${NC}\n"
}

print_success() {
    echo -e "${GREEN}✅${NC}  $1"
}

print_error() {
    echo -e "${RED}❌${NC}  $1"
}

print_warning() {
    echo -e "${YELLOW}⚠️${NC}   $1"
}

print_info() {
    echo -e "${BLUE}ℹ️${NC}   $1"
}

print_debug() {
    echo -e "${CYAN}→${NC}   $1"
}

check_env() {
    if [ ! -f "$ENV_FILE" ]; then
        print_error "Config file not found: $ENV_FILE"
        print_info "Run: ./setup.sh"
        return 1
    fi
    return 0
}

check_docker() {
    if ! command -v docker &> /dev/null; then
        print_error "Docker is not installed"
        return 1
    fi
    return 0
}

check_in_docker_dir() {
    if [ ! -f "$DOCKER_DIR/docker-compose.yml" ]; then
        print_error "docker-compose.yml not found in $DOCKER_DIR"
        return 1
    fi
    return 0
}

show_help() {
    echo ""
    echo -e "${MAGENTA}${BOLD}ServerReport - Management Script${NC}"
    echo -e "${MAGENTA}${BOLD}═══════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "${CYAN}STARTUP & CONTROL${NC}"
    echo -e "  ${BOLD}start${NC}, ${BOLD}up${NC}          Start all services"
    echo -e "  ${BOLD}stop${NC}, ${BOLD}down${NC}        Stop all services"
    echo -e "  ${BOLD}restart${NC}, ${BOLD}reload${NC}   Restart all services"
    echo -e "  ${BOLD}status${NC}, ${BOLD}ps${NC}        Show services status"
    echo ""
    echo -e "${CYAN}LOGS & DEBUGGING${NC}"
    echo -e "  ${BOLD}logs${NC}   [service]   Show logs (website|postgres|discord|telegram)"
    echo -e "  ${BOLD}shell${NC}  [service]   Connect to container shell"
    echo -e "  ${BOLD}health${NC}              Check if all services are healthy"
    echo ""
    echo -e "${CYAN}DATABASE${NC}"
    echo -e "  ${BOLD}db${NC}                 Open PostgreSQL shell"
    echo -e "  ${BOLD}backup${NC}             Backup database to backups/"
    echo -e "  ${BOLD}restore${NC} [file]     Restore database from backup"
    echo ""
    echo -e "${CYAN}BUILD & MAINTENANCE${NC}"
    echo -e "  ${BOLD}build${NC}              Build Docker images"
    echo -e "  ${BOLD}rebuild${NC}            Rebuild without cache"
    echo -e "  ${BOLD}clean${NC}              Stop and remove containers"
    echo -e "  ${BOLD}clean-all${NC}, ${BOLD}nuke${NC} Remove everything (delete data!)"
    echo ""
    echo -e "${CYAN}DEVELOPMENT${NC}"
    echo -e "  ${BOLD}install-deps${NC}       Install npm dependencies"
    echo -e "  ${BOLD}setup${NC}              Run full project setup"
    echo -e "  ${BOLD}config${NC}             Show .env configuration"
    echo -e "  ${BOLD}info${NC}               Show services information"
    echo ""
    echo -e "${CYAN}EXAMPLES${NC}"
    echo -e "  ${BLUE}./manage.sh start${NC}            - Start all services"
    echo -e "  ${BLUE}./manage.sh logs website${NC}     - View website logs"
    echo -e "  ${BLUE}./manage.sh shell postgres${NC}   - Connect to PostgreSQL"
    echo -e "  ${BLUE}./manage.sh backup${NC}           - Backup database"
    echo -e "  ${BLUE}./manage.sh health${NC}           - Check service health"
    echo ""
}

start_services() {
    print_header "Starting Services"
    
    check_docker || return 1
    check_in_docker_dir || return 1
    
    print_debug "Starting containers..."
    cd "$DOCKER_DIR" || return 1
    
    if docker-compose up -d; then
        print_success "Services started"
        sleep 2
        cd "$SCRIPT_DIR" || return 1
        status_services
    else
        print_error "Failed to start services"
        cd "$SCRIPT_DIR" || return 1
        return 1
    fi
}

stop_services() {
    print_header "Stopping Services"
    
    check_docker || return 1
    check_in_docker_dir || return 1
    
    print_debug "Stopping containers..."
    cd "$DOCKER_DIR" || return 1
    
    if docker-compose down; then
        print_success "Services stopped"
        cd "$SCRIPT_DIR" || return 1
    else
        print_error "Failed to stop services"
        cd "$SCRIPT_DIR" || return 1
        return 1
    fi
}

restart_services() {
    print_header "Restarting Services"
    print_debug "Restarting containers..."
    
    check_docker || return 1
    check_in_docker_dir || return 1
    
    cd "$DOCKER_DIR" || return 1
    
    if docker-compose restart; then
        print_success "Services restarted"
        cd "$SCRIPT_DIR" || return 1
        sleep 2
        status_services
    else
        print_error "Failed to restart services"
        cd "$SCRIPT_DIR" || return 1
        return 1
    fi
}

status_services() {
    check_docker || return 1
    check_in_docker_dir || return 1
    
    cd "$DOCKER_DIR" || return 1
    
    echo ""
    echo -e "${CYAN}Docker Containers:${NC}"
    docker-compose ps
    
    echo ""
    echo -e "${CYAN}Network: serverreport-network${NC}"
    
    cd "$SCRIPT_DIR" || return 1
}

show_logs() {
    local service=$1
    
    check_docker || return 1
    check_in_docker_dir || return 1
    
    print_header "Logs"
    
    cd "$DOCKER_DIR" || return 1
    
    if [ -z "$service" ]; then
        print_info "Showing all logs (Ctrl+C to exit)..."
        docker-compose logs -f
    else
        case $service in
            website|web|app)
                docker-compose logs -f website
                ;;
            postgres|db|database)
                docker-compose logs -f postgres
                ;;
            discord|discord-bot)
                docker-compose logs -f discord-bot
                ;;
            telegram|telegram-bot)
                docker-compose logs -f telegram-bot
                ;;
            *)
                print_error "Unknown service: $service"
                echo "Available: website, postgres, discord, telegram"
                cd "$SCRIPT_DIR" || return 1
                return 1
                ;;
        esac
    fi
    
    cd "$SCRIPT_DIR" || return 1
}

shell_service() {
    local service=$1
    
    if [ -z "$service" ]; then
        print_error "Please specify service: website, postgres, discord, telegram"
        return 1
    fi
    
    check_docker || return 1
    check_in_docker_dir || return 1
    
    print_header "Connecting to $service"
    
    cd "$DOCKER_DIR" || return 1
    
    case $service in
        website|web|app)
            docker-compose exec website sh
            ;;
        postgres|db|database)
            docker-compose exec postgres bash
            ;;
        discord|discord-bot)
            docker-compose exec discord-bot sh
            ;;
        telegram|telegram-bot)
            docker-compose exec telegram-bot sh
            ;;
        *)
            print_error "Unknown service: $service"
            echo "Available: website, postgres, discord, telegram"
            cd "$SCRIPT_DIR" || return 1
            return 1
            ;;
    esac
    
    cd "$SCRIPT_DIR" || return 1
}

build_images() {
    print_header "Building Docker Images"
    
    check_docker || return 1
    check_in_docker_dir || return 1
    
    cd "$DOCKER_DIR" || return 1
    
    print_info "Building images, this may take a few minutes..."
    echo ""
    
    if docker-compose build; then
        print_success "All images built successfully"
    else
        print_error "Image build failed"
        cd "$SCRIPT_DIR" || return 1
        return 1
    fi
    
    cd "$SCRIPT_DIR" || return 1
}

rebuild_images() {
    print_header "Rebuilding Docker Images (no cache)"
    
    check_docker || return 1
    check_in_docker_dir || return 1
    
    cd "$DOCKER_DIR" || return 1
    
    print_info "Rebuilding images without cache, this may take a few minutes..."
    echo ""
    
    if docker-compose build --no-cache; then
        print_success "All images rebuilt successfully"
    else
        print_error "Image rebuild failed"
        cd "$SCRIPT_DIR" || return 1
        return 1
    fi
    
    cd "$SCRIPT_DIR" || return 1
}

clean_services() {
    print_header "Cleaning Services"
    
    check_docker || return 1
    check_in_docker_dir || return 1
    
    cd "$DOCKER_DIR" || return 1
    
    print_warning "This will stop and remove containers but keep images and volumes"
    echo ""
    
    print_info "Stopping services..."
    docker-compose down || print_warning "Could not stop services"
    
    print_success "Services cleaned"
    
    cd "$SCRIPT_DIR" || return 1
}

clean_all() {
    print_header "Full Cleanup"
    
    check_docker || return 1
    check_in_docker_dir || return 1
    
    cd "$DOCKER_DIR" || return 1
    
    print_warning "This will REMOVE:"
    echo "  • Containers and networks"
    echo "  • Images (they can be rebuilt)"
    echo "  • Volumes (database data will be LOST)"
    echo ""
    
    read -p "Type 'yes' to continue: " confirm
    if [ "$confirm" != "yes" ]; then
        print_info "Cleanup cancelled"
        cd "$SCRIPT_DIR" || return 1
        return
    fi
    
    print_info "Removing everything..."
    
    docker-compose down -v --rmi all
    
    print_success "Full cleanup completed"
    print_info "Run '$(print_color 32 "./manage.sh start")' to start fresh"
    
    cd "$SCRIPT_DIR" || return 1
}

install_deps() {
    print_header "Installing Dependencies"
    
    print_info "Installing npm dependencies for all services..."
    echo ""
    
    local failed=0
    
    # Website
    if [ -d "$SCRIPT_DIR/website" ]; then
        print_info "Installing website dependencies..."
        cd "$SCRIPT_DIR/website" || return 1
        if npm install; then
            print_success "Website dependencies installed"
        else
            print_error "Failed to install website dependencies"
            failed=1
        fi
    fi
    
    # Discord Bot
    if [ -d "$SCRIPT_DIR/discord-bot" ]; then
        print_info "Installing discord-bot dependencies..."
        cd "$SCRIPT_DIR/discord-bot" || return 1
        if npm install; then
            print_success "Discord-bot dependencies installed"
        else
            print_error "Failed to install discord-bot dependencies"
            failed=1
        fi
    fi
    
    # Telegram Bot
    if [ -d "$SCRIPT_DIR/telegram-bot" ]; then
        print_info "Installing telegram-bot dependencies..."
        cd "$SCRIPT_DIR/telegram-bot" || return 1
        if npm install; then
            print_success "Telegram-bot dependencies installed"
        else
            print_error "Failed to install telegram-bot dependencies"
            failed=1
        fi
    fi
    
    echo ""
    cd "$SCRIPT_DIR" || return 1
    
    if [ $failed -eq 0 ]; then
        print_success "All dependencies installed successfully"
    else
        print_warning "Some dependencies failed to install, see above for details"
        return 1
    fi
}

db_shell() {
    print_header "PostgreSQL Shell"
    print_info "Type \\q to exit"
    
    check_env || return 1
    check_docker || return 1
    check_in_docker_dir || return 1
    
    cd "$DOCKER_DIR" || return 1
    
    # Get DB credentials from .env
    DB_USER=$(grep "^DB_USER=" "$ENV_FILE" | cut -d'=' -f2 | tr -d ' ')
    DB_NAME=$(grep "^DB_NAME=" "$ENV_FILE" | cut -d'=' -f2 | tr -d ' ')
    
    if [ -z "$DB_USER" ] || [ -z "$DB_NAME" ]; then
        print_error "Cannot read database configuration from $ENV_FILE"
        cd "$SCRIPT_DIR" || return 1
        return 1
    fi
    
    docker-compose exec postgres psql -U "$DB_USER" -d "$DB_NAME"
    
    cd "$SCRIPT_DIR" || return 1
}

health_check() {
    print_header "Health Check"
    
    check_docker || return 1
    check_in_docker_dir || return 1
    
    cd "$DOCKER_DIR" || return 1
    
    echo ""
    print_info "Checking services..."
    echo ""
    
    # PostgreSQL
    if docker-compose exec -T postgres pg_isready -U serverreport >/dev/null 2>&1; then
        print_success "PostgreSQL is healthy"
    else
        print_error "PostgreSQL is not responding"
    fi
    
    # Website
    if curl -s http://localhost:3000/health >/dev/null 2>&1; then
        print_success "Website is healthy"
    else
        print_warning "Website is not responding"
    fi
    
    # Discord Bot
    if docker-compose ps | grep -q "discord-bot.*Up"; then
        print_success "Discord bot is running"
    else
        print_warning "Discord bot is not running"
    fi
    
    # Telegram Bot
    if docker-compose ps | grep -q "telegram-bot.*Up"; then
        print_success "Telegram bot is running"
    else
        print_warning "Telegram bot is not running"
    fi
    
    echo ""
    
    cd "$SCRIPT_DIR" || return 1
}

backup_db() {
    print_header "Database Backup"
    
    check_env || return 1
    check_docker || return 1
    check_in_docker_dir || return 1
    
    local backup_dir="$SCRIPT_DIR/backups"
    local timestamp=$(date +"%Y%m%d_%H%M%S")
    local backup_file="$backup_dir/serverreport_$timestamp.sql"
    
    if [ ! -d "$backup_dir" ]; then
        mkdir -p "$backup_dir"
        print_debug "Created backup directory: $backup_dir"
    fi
    
    cd "$DOCKER_DIR" || return 1
    
    DB_USER=$(grep "^DB_USER=" "$ENV_FILE" | cut -d'=' -f2 | tr -d ' ')
    DB_NAME=$(grep "^DB_NAME=" "$ENV_FILE" | cut -d'=' -f2 | tr -d ' ')
    
    print_info "Creating backup to $backup_file..."
    
    if docker-compose exec -T postgres pg_dump -U "$DB_USER" "$DB_NAME" > "$backup_file"; then
        local size=$(du -h "$backup_file" | cut -f1)
        print_success "Database backed up successfully"
        print_info "File: $(basename "$backup_file")"
        print_info "Size: $size"
    else
        print_error "Backup failed"
        cd "$SCRIPT_DIR" || return 1
        return 1
    fi
    
    cd "$SCRIPT_DIR" || return 1
}

restore_db() {
    local backup_file=$1
    
    if [ -z "$backup_file" ]; then
        print_error "Please specify backup file"
        echo ""
        echo "Available backups:"
        ls -lh "$SCRIPT_DIR/backups/"*.sql 2>/dev/null || echo "  No backups found"
        echo ""
        print_info "Usage: ./manage.sh db-restore backups/serverreport_20260222_120000.sql"
        return 1
    fi
    
    if [ ! -f "$backup_file" ]; then
        print_error "Backup file not found: $backup_file"
        return 1
    fi
    
    print_header "Database Restore"
    print_warning "This will OVERWRITE your current database!"
    echo ""
    
    read -p "Type 'yes' to continue: " confirm
    if [ "$confirm" != "yes" ]; then
        print_info "Restore cancelled"
        return
    fi
    
    check_env || return 1
    check_docker || return 1
    check_in_docker_dir || return 1
    
    cd "$DOCKER_DIR" || return 1
    
    DB_USER=$(grep "^DB_USER=" "$ENV_FILE" | cut -d'=' -f2 | tr -d ' ')
    DB_NAME=$(grep "^DB_NAME=" "$ENV_FILE" | cut -d'=' -f2 | tr -d ' ')
    
    print_info "Restoring database from $backup_file..."
    
    if docker-compose exec -T postgres psql -U "$DB_USER" "$DB_NAME" < "$backup_file"; then
        print_success "Database restored successfully"
    else
        print_error "Restore failed"
        cd "$SCRIPT_DIR" || return 1
        return 1
    fi
    
    cd "$SCRIPT_DIR" || return 1
}

setup() {
    print_header "Running Setup"
    
    if [ ! -f "$SCRIPT_DIR/setup.sh" ]; then
        print_error "setup.sh not found in $SCRIPT_DIR"
        return 1
    fi
    
    print_info "Launching setup script..."
    bash "$SCRIPT_DIR/setup.sh"
}

config_show() {
    print_header "Current Configuration"
    
    check_env || return 1
    
    echo ""
    echo "Environment Variables:"
    echo ""
    
    grep -E "^[A-Z_]+=" "$ENV_FILE" | while IFS='=' read -r key value; do
        # Hide sensitive values
        if [[ "$key" =~ (PASSWORD|TOKEN|SECRET|KEY) ]]; then
            echo "  $(print_color 33 "$key")=***hidden***"
        else
            echo "  $(print_color 33 "$key")=$value"
        fi
    done
    
    echo ""
}

info_services() {
    print_header "Project Services"
    
    echo ""
    echo "$(print_color 36 '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━')"
    echo "$(print_color 36 '  SERVICE')"
    echo "$(print_color 36 '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━')"
    echo ""
    
    echo "$(print_color 32 '  website')         Express.js server (Port 3000)"
    echo "                  Routes: /api, /admin, /auth, /reports"
    echo ""
    
    echo "$(print_color 32 '  postgres')        PostgreSQL database (Port 5432)"
    echo "                  Database management and data storage"
    echo ""
    
    echo "$(print_color 32 '  discord-bot')     Discord.js bot"
    echo "                  Commands: /report, /status"
    echo ""
    
    echo "$(print_color 32 '  telegram-bot')    Telegraf bot"
    echo "                  Automated reporting via Telegram"
    echo ""
    
    echo "$(print_color 36 '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━')"
    echo ""
}

# Main
case "${1:-help}" in
    start|up)
        start_services
        ;;
    stop|down)
        stop_services
        ;;
    restart|reload)
        restart_services
        ;;
    status|ps)
        status_services
        ;;
    logs|log|l)
        show_logs "$2"
        ;;
    shell|sh|exec)
        shell_service "$2"
        ;;
    build)
        build_images
        ;;
    rebuild)
        rebuild_images
        ;;
    clean)
        clean_services
        ;;
    clean-all|nuke)
        clean_all
        ;;
    install-deps|deps|npm)
        install_deps
        ;;
    db|db-shell)
        db_shell
        ;;
    health|health-check)
        health_check
        ;;
    backup|backup-db)
        backup_db
        ;;
    restore|restore-db)
        restore_db "$2"
        ;;
    setup|init)
        setup
        ;;
    config|conf|env)
        config_show
        ;;
    info|services)
        info_services
        ;;
    help|h|"")
        show_help
        ;;
    *)
        print_error "Unknown command: $1"
        echo ""
        show_help
        exit 1
        ;;
esac
